/*!
 * Ajax Bootstrap Select
 *
 * Extends the bootstrap-select plugin so it can use a remote source for searching. Originally for CROSCON.
 *
 * @version 1.2.0
 * @author Adam Heim - https://github.com/truckingsim
 * @link https://github.com/truckingsim/Ajax-Bootstrap-Select
 * @copyright 2014 Adam Heim
 * @license Released under the MIT license.
 *
 * Contributors:
 *   Mark Carver - https://github.com/markcarver
 *
 * Last build: 2014-09-23 6:40:14 PM CDT
 */
!function(a,b){var c=function(b,c){var d,e=this;if(this.options={},c=c||{},this.LOG_ERROR=1,this.LOG_WARNING=2,this.LOG_INFO=3,this.LOG_DEBUG=4,this.$element=a(b),this.$loading=a(),this.$noResults=a(),this.selectpicker=this.$element.data("selectpicker"),!this.selectpicker)return void this.log(this.LOG_ERROR,"Cannot attach ajax without selectpicker being run first!");this.cachedData={},this.previousQuery="",this.query="",d={ajaxOptions:{},bindEvent:"keyup",cache:!0,clearOnEmpty:!0,emptyRequest:!1,ignoredKeys:{9:"tab",16:"shift",17:"ctrl",18:"alt",27:"esc",37:"left",39:"right",38:"up",40:"down",91:"meta",229:"unknown"},log:1,preprocessData:null,preserveSelected:"auto",processData:null,searchPlaceholder:"Search...",templates:{loading:'<div class="menu-loading">Loading...</div>',noResults:'<div class="no-results">No Results</div>'}},this.options=a.extend(!0,{},d,c);var f=[{from:"ajaxResultsPreHook",to:"preprocessData"},{from:"ajaxSearchUrl",to:{ajaxOptions:{url:"{{{value}}}"}}},{from:"debug",to:function(b){var c={};c.log=Boolean(e.options[b.from])?e.LOG_DEBUG:0,a.extend(e.options,c),delete e.options[b.from],e.log(e.LOG_WARNING,'Deprecated option "'+b.from+'". Update code to use:',c)}},{from:"mixWithCurrents",to:"preserveSelected"},{from:"placeHolderOption",to:function(b){var d={templates:{noResults:'<div class="no-results">'+c[b.from]+"</div>"}};a.extend(e.options,d),delete e.options[b.from],e.log(e.LOG_WARNING,'Deprecated option "'+b.from+'". Update code to use:',d)}}];if(f.length&&a.map(f,function(b){if(e.options[b.from])if(a.isPlainObject(b.to))e.replaceValue(b.to,"{{{value}}}",e.options[b.from]),e.options=a.extend(!0,{},e.options,b.to),e.log(e.LOG_WARNING,'Deprecated option "'+b.from+'". Update code to use:',b.to),delete e.options[b.from];else if(a.isFunction(b.to))b.to.apply(e,[b]);else{var c={};c[b.to]=e.options[b.from],a.extend(e.options,c),e.log(e.LOG_WARNING,'Deprecated option "'+b.from+'". Update code to use:',c),delete e.options[b.from]}}),this.options.preserveSelected&&"auto"===this.options.preserveSelected&&(this.options.preserveSelected=this.selectpicker.multiple),this.$element.data("searchUrl")&&(this.options.ajaxOptions.url=this.$element.data("searchUrl")),"number"!=typeof this.options.log)switch("string"==typeof this.options.log&&(this.options.log=this.options.log.toLowerCase()),this.options.log){case!0:case"debug":this.options.log=this.LOG_DEBUG;break;case"info":this.options.log=this.LOG_INFO;break;case"warn":case"warning":this.options.log=this.LOG_WARNING;break;default:case!1:case"error":this.options.log=this.LOG_ERROR}return this.options.ajaxOptions.url?void setTimeout(function(){e.init()},500):void this.log(this.LOG_ERROR,"ajaxOptions.url must be set! Options:",this.options)};b.AjaxBootstrapSelect=b.AjaxBootstrapSelect||c,c.prototype.init=function(){var b=this;this.list=new d(this);var c;this.selectpicker.$searchbox.attr("placeholder",this.options.searchPlaceholder).off("input propertychange").on(this.options.bindEvent,function(d){if(b.log(b.LOG_DEBUG,'Bind event fired: "'+b.options.bindEvent+'", keyCode:',d.keyCode,d),b.query=b.selectpicker.$searchbox.val(),b.options.cache||(b.options.ignoredKeys[13]="enter"),b.options.ignoredKeys[d.keyCode])return b.log(b.LOG_DEBUG,"Key ignored."),!0;if(!b.query.length&&(b.options.clearOnEmpty&&b.list.destroy(),!b.options.emptyRequest))return!0;if(clearTimeout(c),b.options.cache&&b.cachedData[b.query]&&13!==d.keyCode){var e=b.list.build(b.cachedData[b.query]);return e.length?(b.$element.html(e),b.list.refresh(),!0):(b.log(b.LOG_WARNING,"Unable to build the options from cached data.",b.query,b.cachedData[b.query]),void b.list.restore())}c=setTimeout(function(){b.list.save(),b.list.destroy(),b.$loading.remove(),b.$noResults.remove(),b.options.templates.loading&&(b.$loading=a(b.options.templates.loading).appendTo(b.selectpicker.$menu),b.list.refresh());var c={};c.url=b.options.ajaxOptions.url,c.success=function(c,d,e){if(b.log(b.LOG_INFO,"AJAX success event:",c,d,e),!a.isArray(c)&&!a.isObject(c))return b.log(b.LOG_ERROR,"Request did not return a JSON Array or Object.",c),void b.list.destroy();if(!Object.keys(c).length)return b.list.destroy(),b.options.templates.noResults&&(b.$noResults=a(b.options.templates.noResults).appendTo(b.selectpicker.$menu)),void b.log(b.LOG_INFO,"No results were returned.");var f=b.processData(c,b.query);if(f&&f.length){var g=b.list.build(f);if(!g.length)return void b.log(b.LOG_WARNING,"Unable to build the options from data.",c,g);b.$element.html(g)}},c.error=function(a,c,d){b.log(b.LOG_ERROR,"AJAX error event:",a,c,d),b.list.restore()},c.complete=function(a,c){b.log(b.LOG_INFO,"AJAX complete event:",a,c),b.$loading.remove(),b.list.refresh()};var d=a.extend(!0,{},b.options.ajaxOptions);c.dataType=d.hasOwnProperty("dataType")?d.dataType:"json",c.type=d.hasOwnProperty("type")?d.type:"POST",d.hasOwnProperty("data")?(d.processedData=d.data,"function"==typeof d.data&&(d.processedData=d.data()),c.data=d.processedData):d.data={q:b.query},b.replaceValue(c.data,"{{{q}}}",b.query),a.ajax(c)},300)})},c.prototype.log=function(a,c){if(this.options.log&&b.console&&"number"==typeof a&&a<=this.options.log){var d=[].slice.apply(arguments,[2]);switch(a){case this.LOG_DEBUG:a="debug";break;case this.LOG_INFO:a="info";break;case this.LOG_WARNING:a="warn";break;default:case this.LOG_ERROR:a="error"}var e="["+a.toUpperCase()+"] AjaxBootstrapSelect:";"string"==typeof c?d.unshift(e+" "+c):(d.unshift(c),d.unshift(e)),b.console[a].apply(b.console,d)}},c.prototype.processData=function(b,c){var d,e,f,g,h,i,j,k=[],l=[],m=[];if(this.log(this.LOG_INFO,"Processing raw data for:",c,b),this.options.preserveSelected&&this.list&&(h=this.list.last())&&h&&(m=m.concat(h.selected)),a.isPlainObject(b))f=m.concat(a.map(b,function(a){return[a]}));else{if(!a.isArray(b))return this.log(this.LOG_ERROR,"The data type passed was not an Array or Object.",b),!1;f=m.concat(b)}if(i=[].concat(f),a.isFunction(this.options.preprocessData)&&(this.log(this.LOG_DEBUG,"Invoking preprocessData callback:",this.options.processData),i=this.options.preprocessData(i),!a.isArray(i)||!i.length))return this.log(this.LOG_ERROR,"The preprocessData callback did not return an array or was empty.",b,i),!1;for(e=i.length,d=0;e>d;d++)g=i[d],this.log(this.LOG_DEBUG,"Processing item:",g),a.isPlainObject(g)&&(g.hasOwnProperty("divider")||g.hasOwnProperty("data")&&a.isPlainObject(g.data)&&g.data.divider?(this.log(this.LOG_DEBUG,"Item is a divider, ignoring provided data."),k.push({divider:!0})):g.hasOwnProperty("value")?-1===l.indexOf(g.value)?(l.push(g.value),g=a.extend({title:g.value,"class":"",data:{},disabled:!1,selected:!1},g),k.push(g)):this.log(this.LOG_DEBUG,"Duplicate item found, ignoring."):this.log(this.LOG_DEBUG,'Data item must have a "value" property, skipping.'));return j=[].concat(k),!a.isFunction(this.options.processData)||(this.log(this.LOG_DEBUG,"Invoking processData callback:",this.options.processData),j=this.options.processData(j),a.isArray(j)&&j.length)?(this.options.cache&&c&&(this.log(this.LOG_DEBUG,"Caching processed data."),this.cachedData[c]=j),this.log(this.LOG_INFO,"Processed data:",j),j):(this.log(this.LOG_ERROR,"The processedData callback did not return an array or was empty.",b,k,j),!1)},c.prototype.replaceValue=function(b,c,d,e){var f=this;e=a.extend({recursive:!0,depth:!1,limit:!1},e),a.each(b,function(g,h){return e.limit!==!1&&"number"==typeof e.limit&&e.limit<=0?!1:void(a.isArray(b[g])||a.isPlainObject(b[g])?(e.recursive&&e.depth===!1||e.recursive&&"number"==typeof e.depth&&e.depth>0)&&f.replaceValue(b[g],c,d,e):h===c&&(e.limit!==!1&&"number"==typeof e.limit&&e.limit--,b[g]=d))})};var d=function(b){this.states=[],a.extend(this,b)};b.AjaxBootstrapSelectList=b.AjaxBootstrapSelectList||d,d.prototype.build=function(b){var c,d,e=b.length,f=a("<select/>");for(this.log(this.LOG_DEBUG,"Building the select list options from data:",b),d=0;e>d;d++){var g=b[d],h=a("<option/>");if(g.hasOwnProperty("divider"))h.attr("data-divider","true"),f.append(h);else{h.val(g.value).text(g.text).attr("class",g.class).prop("disabled",g.disabled),g.selected&&!this.selectpicker.multiple&&f.find(":selected").prop("selected",!1),h.prop("selected",g.selected);for(c in g.data)g.data.hasOwnProperty(c)&&h.attr("data-"+c,g.data[c]);f.append(h)}}var i=f.html();return this.log(this.LOG_DEBUG,i),i},d.prototype.destroy=function(){this.$element.find("option").remove(),this.log(this.LOG_DEBUG,"Destroyed select list."),this.refresh()},d.prototype.last=function(){if(this.states.length){var a=this.states[this.states.length-1];return this.log(this.LOG_DEBUG,"Retrieved the last saved state of the select list:",a),a}return this.log(this.LOG_DEBUG,"Unable to retrieve the last saved state of the select list."),!1},d.prototype.refresh=function(){this.selectpicker.$menu.css("minHeight",0),this.selectpicker.$menu.find("> .inner").css("minHeight",0),this.selectpicker.refresh(),this.selectpicker.findLis?this.selectpicker.findLis():this.selectpicker.$lis=this.selectpicker.$menu.find("li"),this.log(this.LOG_DEBUG,"Refreshed select list.")},d.prototype.restore=function(){if(this.states.length){var a=this.states.pop();return this.$element.html(a.html),this.log(this.LOG_DEBUG,"Restored select list to a previous state:",a),!0}return this.log(this.LOG_DEBUG,"Unable to restore select list to a previous state."),!1},d.prototype.save=function(b){var c=[];if(b=b||!1,b||(this.states=[]),this.options.preserveSelected){var d=this.$element.find(":selected");this.selectpicker.multiple||(d=d.last()),d.each(function(){var b=a(this),d=b.val();c.push({value:d,text:b.text(),data:b.data()||{},preserved:!0,selected:!0})})}var e={selected:c,html:this.$element.html()};this.states.push(e),this.log(this.LOG_DEBUG,"Saved the current state of the select list:",e)},a.fn.ajaxSelectPicker=function(c){return this.each(function(){a(this).data("AjaxBootstrapSelect")||a(this).data("AjaxBootstrapSelect",new b.AjaxBootstrapSelect(this,c))})}}(jQuery,window);