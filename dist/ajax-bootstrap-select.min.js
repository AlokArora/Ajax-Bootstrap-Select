/*!
 * Ajax Bootstrap Select
 *
 * Extends the bootstrap-select plugin so it can use a remote source for searching. Originally for CROSCON.
 *
 * @version 1.1.0
 * @author Adam Heim - https://github.com/truckingsim
 * @link https://github.com/truckingsim/Ajax-Bootstrap-Select
 * @copyright 2014 Adam Heim
 * @license Licensed under MIT
 *
 * Contributors:
 *   Mark Carver - https://github.com/markcarver
 *
 * Last build: 2014-09-22 2:48:26 AM CDT
 */
!function(a,b){var c=function(c,d){var e=this,f=a(c),g={destroyLi:function(){this.$menu.find("li").remove()}},h=[{from:"ajaxResultsPreHook",to:"preprocessData"},{from:"mixWithCurrents",to:"preserveSelected"},{from:"ajaxSearchUrl",to:{ajaxOptions:{url:"{{{value}}}"}}}],i={ajaxSearchUrl:null,ajaxOptions:{},bindEvent:"keyup",cache:!0,emptyClear:!0,emptyRequest:!1,ignoredKeys:{9:"tab",16:"shift",17:"ctrl",18:"alt",27:"esc",37:"left",39:"right",38:"up",40:"down",91:"meta",229:"unknown"},placeHolderOption:null,preprocessData:null,processData:null,debug:!1,preserveSelected:"auto",loadingTemplate:'<div class="menu-loading">Loading...</div>',searchPlaceholder:null};a.extend(e,g),e.options=a.extend(i,d,{}),e.init=function(){if(e.cachedData={},e.states=[],e.query="",e.previousQuery="",e.$loading=a(),a.map(h,function(b){a.isPlainObject(b.to)&&e.options[b.from]?(e.replaceValue(b.to,"{{{value}}}",d[b.from]),e.options=a.extend(!0,{},e.options,b.to),e.log(['[WARNING] ajaxSelectPicker: Depreciated option "'+b.from+'". Update code to use:',b.to]),delete e.options[b.from]):e.options[b.from]&&(e.options[b.to]=d[b.from],e.log(['[WARNING] ajaxSelectPicker: Depreciated option "'+b.from+'". Update code to use: "'+b.to+'"']),delete e.options[b.from])}),"auto"===e.options.preserveSelected&&(e.options.preserveSelected=e.multiple),f.attr("data-search-url")&&(e.options.ajaxSearchUrl=f.attr("data-search-url")),f.data().hasOwnProperty("selectpicker"))if(null==e.options.ajaxOptions.url)this.log("ajaxSelectPicker: ajaxOptions.url must be set!",!0);else{var b;a.extend(e,f.data().selectpicker),e.$searchbox.attr("placeholder",e.options.searchPlaceholder).off("input propertychange").on(e.options.bindEvent,function(c){if(e.query=e.$searchbox.val(),e.options.cache||(e.options.ignoredKeys[13]="enter"),e.options.ignoredKeys[c.keyCode])return!0;if(!e.query.length&&(e.options.emptyClear||e.destroyLi(),!e.options.emptyRequest))return!0;if(clearTimeout(b),e.options.cache&&e.cachedData[e.query]&&13!==c.keyCode){var d=e.buildOptions(e.cachedData[e.query]);return d.length?(e.$element.html(d),e.$element.selectpicker("refresh"),!0):(e.log(["ajaxSelectPicker: Unable to build the options from cached data.",e.query,e.cachedData[e.query]],!0),void e.restoreState())}b=setTimeout(function(){e.saveState(),e.$element.find("option").remove(),e.destroyLi(),e.$menu.css("minHeight",0),e.$menu.find("> .inner").css("minHeight",0),e.$loading.remove(),e.$loading=a(e.options.loadingTemplate),e.$menu.append(e.$loading),e.$element.selectpicker("refresh");var b={};b.url=e.options.ajaxOptions.url,b.success=function(a){var b=e.processData(a,e.query);if(b){var c=e.buildOptions(b);if(c.length)return void e.$element.html(c);e.log(["ajaxSelectPicker: Unable to build the options from data.",a,c],!0)}else e.log(["ajaxSelectPicker: Unable to process data.",a],!0);e.restoreState()},b.error=function(a){e.log(["ajaxSelectPicker:",a],!0),e.restoreState()},b.complete=function(){e.$loading.remove(),e.$element.selectpicker("refresh")};var c=a.extend(!0,{},e.options.ajaxOptions);b.dataType=c.hasOwnProperty("dataType")?c.dataType:"json",b.type=c.hasOwnProperty("type")?c.type:"POST",c.hasOwnProperty("data")?(c.processedData=c.data,"function"==typeof c.data&&(c.processedData=c.data()),b.data=c.processedData):c.data={q:e.query},e.replaceValue(b.data,"{{{q}}}",e.query),a.ajax(b)},300)})}else this.log("ajaxSelectPicker: Cannot attach ajax without selectpicker being run first!",!0)},e.replaceValue=function(b,c,d,f){f=a.extend({recursive:!0,depth:!1,limit:!1},f),a.each(b,function(g,h){return f.limit!==!1&&"number"==typeof f.limit&&f.limit<=0?!1:void(a.isArray(b[g])||a.isPlainObject(b[g])?(f.recursive&&f.depth===!1||f.recursive&&"number"==typeof f.depth&&f.depth>0)&&e.replaceValue(b[g],c,d,f):h===c&&(f.limit!==!1&&"number"==typeof f.limit&&f.limit--,b[g]=d))})},e.saveState=function(b){var c=[];if(b=b||!1,b||(e.states=[]),e.options.preserveSelected){var d=e.$element.find(":selected");e.multiple||(d=d.last()),d.each(function(){var b=a(this),d=b.val();c.push({value:d,text:b.text(),data:b.data()||{},preserved:!0,selected:!0})})}e.states.push({selected:c,html:e.$element.html()})},e.restoreState=function(){return e.states.length?(e.$element.html(e.states.pop().html),!0):!1},e.getLastState=function(){return e.states.length?e.states[e.states.length-1]:!1},e.processData=function(b,c){var d,f,g,h,i,j,k,l=[],m=[],n=[];if(e.options.preserveSelected&&(i=e.getLastState())&&i&&(n=n.concat(i.selected)),a.isPlainObject(b))g=n.concat(a.map(b,function(a){return[a]}));else{if(!a.isArray(b))return e.log(["ajaxSelectPicker: The data type passed was not an Array or Object.",b],!0),!1;g=n.concat(b)}if(j=[].concat(g),a.isFunction(e.options.preprocessData)&&(j=e.options.preprocessData(j),!a.isArray(j)||!j.length))return e.log(["ajaxSelectPicker: The preprocessData callback did not return an array or was empty.",b,j],!0),!1;for(f=j.length,d=0;f>d;d++)h=j[d],a.isPlainObject(h)&&(h.hasOwnProperty("divider")||h.hasOwnProperty("data")&&a.isPlainObject(h.data)&&h.data.divider?l.push({divider:!0}):h.hasOwnProperty("value")?-1===m.indexOf(h.value)?(m.push(h.value),h=a.extend({title:h.value,"class":"",data:{},disabled:!1,selected:!1},h),l.push(h)):this.log(["ajaxSelectPicker: Duplicate item found, ignoring.",h]):this.log(['ajaxSelectPicker: Data item must have a "value" property, skipping.',h],!0));return k=[].concat(l),!a.isFunction(e.options.processData)||(k=e.options.processData(k),a.isArray(k)&&k.length)?(e.options.cache&&c&&(e.cachedData[c]=k),k):(e.log(["ajaxSelectPicker: The processedData callback did not return an array or was empty.",b,l,k],!0),!1)},e.buildOptions=function(b){var c,d,f=b.length,g=a("<select/>");for(d=0;f>d;d++){var h=b[d],i=a("<option/>");if(h.hasOwnProperty("divider"))i.attr("data-divider","true"),g.append(i);else{i.val(h.value).text(h.text).attr("class",h.class).prop("disabled",h.disabled),h.selected&&!e.multiple&&g.find(":selected").prop("selected",!1),i.prop("selected",h.selected);for(c in h.data)h.data.hasOwnProperty(c)&&i.attr("data-"+c,h.data[c]);g.append(i)}}return g.find("option").length&&"string"==typeof e.options.placeHolderOption&&e.options.placeHolderOption.length&&g.prepend('<option data-hidden="true">'+e.options.placeHolderOption+"</option>"),g.html()},e.log=function(a,c){b.console&&e.options.debug&&(a=a instanceof Array?a:[a],b.console[c?"error":"log"].apply(b.console,a))},setTimeout(function(){e.init()},500)};a.fn.ajaxSelectPicker=function(b){return this.each(function(){a(this).data("ajaxSelectPicker")||a(this).data("ajaxSelectPicker",new c(this,b))})}}(jQuery,window);