/*!
 * Ajax Bootstrap Select
 *
 * Extends the bootstrap-select plugin so it can use a remote source for searching. Originally for CROSCON.
 *
 * @version 1.2.0
 * @author Adam Heim - https://github.com/truckingsim
 * @link https://github.com/truckingsim/Ajax-Bootstrap-Select
 * @copyright 2014 Adam Heim
 * @license Released under the MIT license.
 *
 * Contributors:
 *   Mark Carver - https://github.com/markcarver
 *
 * Last build: 2014-09-24 6:45:53 AM CDT
 */
!function(a,b){var c=function(c,e){var f,g=this;if(this.options={},e=e||{},this.LOG_ERROR=1,this.LOG_WARNING=2,this.LOG_INFO=3,this.LOG_DEBUG=4,this.$element=a(c),this.$loading=a(),this.$noResults=a(),this.selectpicker=this.$element.data("selectpicker"),!this.selectpicker)return void this.log(this.LOG_ERROR,"Cannot attach ajax without selectpicker being run first!");this.cachedData={},this.query="",f={ajaxOptions:{url:null,type:"POST",dataType:"json",data:{q:"{{{q}}}"}},bindEvent:"keyup",cache:!0,clearOnEmpty:!0,emptyRequest:!1,ignoredKeys:{9:"tab",16:"shift",17:"ctrl",18:"alt",27:"esc",37:"left",39:"right",38:"up",40:"down",91:"meta",229:"unknown"},langCode:null,log:1,preprocessData:null,preserveSelected:"auto",processData:null,requestDelay:300,templates:{loading:'<div class="menu-loading">Loading...</div>',noResults:'<div class="no-results">No Results</div>'}},this.options=a.extend(!0,{},f,e);var h=[{from:"ajaxResultsPreHook",to:"preprocessData"},{from:"ajaxSearchUrl",to:{ajaxOptions:{url:"{{{value}}}"}}},{from:"debug",to:function(b){var c={};c.log=Boolean(g.options[b.from])?g.LOG_DEBUG:0,a.extend(g.options,c),delete g.options[b.from],g.log(g.LOG_WARNING,'Deprecated option "'+b.from+'". Update code to use:',c)}},{from:"mixWithCurrents",to:"preserveSelected"},{from:"placeHolderOption",to:function(b){var c={templates:{noResults:'<div class="no-results">'+e[b.from]+"</div>"}};a.extend(g.options,c),delete g.options[b.from],g.log(g.LOG_WARNING,'Deprecated option "'+b.from+'". Update code to use:',c)}}];if(h.length&&a.map(h,function(b){if(g.options[b.from])if(a.isPlainObject(b.to))g.replaceValue(b.to,"{{{value}}}",g.options[b.from]),g.options=a.extend(!0,{},g.options,b.to),g.log(g.LOG_WARNING,'Deprecated option "'+b.from+'". Update code to use:',b.to),delete g.options[b.from];else if(a.isFunction(b.to))b.to.apply(g,[b]);else{var c={};c[b.to]=g.options[b.from],a.extend(g.options,c),g.log(g.LOG_WARNING,'Deprecated option "'+b.from+'". Update code to use:',c),delete g.options[b.from]}}),this.options.preserveSelected&&"auto"===this.options.preserveSelected&&(this.options.preserveSelected=this.selectpicker.multiple),this.$element.data("searchUrl")&&(this.options.ajaxOptions.url=this.$element.data("searchUrl")),"number"!=typeof this.options.log)switch("string"==typeof this.options.log&&(this.options.log=this.options.log.toLowerCase()),this.options.log){case!0:case"debug":this.options.log=this.LOG_DEBUG;break;case"info":this.options.log=this.LOG_INFO;break;case"warn":case"warning":this.options.log=this.LOG_WARNING;break;default:case!1:case"error":this.options.log=this.LOG_ERROR}if(!this.options.ajaxOptions.url)return void this.log(this.LOG_ERROR,"ajaxOptions.url must be set! Options:",this.options);if(this.locale=a.extend(!0,{},a.fn.ajaxSelectPicker.locale),this.options.langCode=this.options.langCode||b.navigator.userLanguage||b.navigator.language||"en",!this.locale[this.options.langCode]){var i=this.options.langCode;this.options.langCode="en";var j,k=i.split("-"),l=k.length;for(j=0;l>j;j++){var m=k.join("-");if(m.length&&this.locale[m]){this.options.langCode=m;break}k.pop()}this.log(this.LOG_WARNING,'Unknown langCode option: "'+i+'". Using the following langCode instead: "'+this.options.langCode+'".')}this.locale[this.options.langCode]=a.extend(!0,{},this.locale[this.options.langCode],this.options.locale),this.list=new d(this),setTimeout(function(){g.init()},500)};b.AjaxBootstrapSelect=b.AjaxBootstrapSelect||c,c.prototype.init=function(){var a,b=this;this.selectpicker.$searchbox.attr("placeholder",this.t("searchPlaceholder")),this.selectpicker.$searchbox.off().on(this.options.bindEvent,function(c){var d=b.selectpicker.$searchbox.val();if(b.log(b.LOG_DEBUG,'Bind event fired: "'+b.options.bindEvent+'", keyCode:',c.keyCode,c),b.options.cache||(b.options.ignoredKeys[13]="enter"),b.options.ignoredKeys[c.keyCode])return void b.log(b.LOG_DEBUG,"Key ignored.");if(clearTimeout(a),d.length||(b.options.clearOnEmpty&&b.list.destroy(),b.options.emptyRequest)){if(b.query=d,b.options.cache&&b.cachedData[b.query]&&13!==c.keyCode){var f=b.list.build(b.cachedData[b.query]);return f.length?(b.$element.html(f),void b.list.refresh()):(b.log(b.LOG_WARNING,"Unable to build the options from cached data.",b.query,b.cachedData[b.query]),void b.list.restore())}a=setTimeout(function(){b.lastRequest=new e(b)},b.options.requestDelay||300)}})},c.prototype.log=function(a,c){if(this.options.log&&b.console&&"number"==typeof a&&a<=this.options.log){var d=[].slice.apply(arguments,[2]);switch(a){case this.LOG_DEBUG:a="debug";break;case this.LOG_INFO:a="info";break;case this.LOG_WARNING:a="warn";break;default:case this.LOG_ERROR:a="error"}var e="["+a.toUpperCase()+"] AjaxBootstrapSelect:";"string"==typeof c?d.unshift(e+" "+c):(d.unshift(c),d.unshift(e)),b.console[a].apply(b.console,d)}},c.prototype.replaceValue=function(b,c,d,e){var f=this;e=a.extend({recursive:!0,depth:!1,limit:!1},e),a.each(b,function(g,h){return e.limit!==!1&&"number"==typeof e.limit&&e.limit<=0?!1:void(a.isArray(b[g])||a.isPlainObject(b[g])?(e.recursive&&e.depth===!1||e.recursive&&"number"==typeof e.depth&&e.depth>0)&&f.replaceValue(b[g],c,d,e):h===c&&(e.limit!==!1&&"number"==typeof e.limit&&e.limit--,b[g]=d))})},c.prototype.t=function(a,b){return b=b||this.options.langCode,this.locale[b]&&this.locale[b][a]?this.locale[b][a]:(this.log(this.LOG_WARNING,"Unknown translation key:",a),a)};var d=function(b){this.states=[],a.extend(this,b)};b.AjaxBootstrapSelectList=b.AjaxBootstrapSelectList||d,d.prototype.build=function(b){var c,d,e=b.length,f=a("<select/>");for(this.log(this.LOG_DEBUG,"Building the select list options from data:",b),d=0;e>d;d++){var g=b[d],h=a("<option/>");if(g.hasOwnProperty("divider"))h.attr("data-divider","true"),f.append(h);else{h.val(g.value).text(g.text).attr("class",g.class).prop("disabled",g.disabled),g.selected&&!this.selectpicker.multiple&&f.find(":selected").prop("selected",!1),h.prop("selected",g.selected);for(c in g.data)g.data.hasOwnProperty(c)&&h.attr("data-"+c,g.data[c]);f.append(h)}}var i=f.html();return this.log(this.LOG_DEBUG,i),i},d.prototype.destroy=function(){this.$element.find("option").remove(),this.log(this.LOG_DEBUG,"Destroyed select list."),this.refresh()},d.prototype.last=function(){if(this.states.length){var a=this.states[this.states.length-1];return this.log(this.LOG_DEBUG,"Retrieved the last saved state of the select list:",a),a}return this.log(this.LOG_DEBUG,"Unable to retrieve the last saved state of the select list."),!1},d.prototype.refresh=function(){this.selectpicker.$menu.css("minHeight",0),this.selectpicker.$menu.find("> .inner").css("minHeight",0),this.selectpicker.refresh(),this.selectpicker.findLis?this.selectpicker.findLis():this.selectpicker.$lis=this.selectpicker.$menu.find("li"),this.log(this.LOG_DEBUG,"Refreshed select list.")},d.prototype.restore=function(){if(this.states.length){var a=this.states.pop();return this.$element.html(a.html),this.log(this.LOG_DEBUG,"Restored select list to a previous state:",a),!0}return this.log(this.LOG_DEBUG,"Unable to restore select list to a previous state."),!1},d.prototype.save=function(b){var c=[];if(b=b||!1,b||(this.states=[]),this.options.preserveSelected){var d=this.$element.find(":selected");this.selectpicker.multiple||(d=d.last()),d.each(function(){var b=a(this),d=b.val();c.push({value:d,text:b.text(),data:b.data()||{},preserved:!0,selected:!0})})}var e={selected:c,html:this.$element.html()};this.states.push(e),this.log(this.LOG_DEBUG,"Saved the current state of the select list:",e)};var e=function(b){var c,d=this,e=function(a){return function(){d.plugin.log(d.plugin.LOG_INFO,"Invoking AjaxBootstrapSelectRequest."+a+" callback:",arguments),d[a].apply(d,arguments),d.callbacks[a]&&(d.plugin.log(d.plugin.LOG_INFO,"Invoking ajaxOptions."+a+" callback:",arguments),d.callbacks[a].apply(d,arguments))}},f=["beforeSend","success","error","complete"],g=f.length;for(this.plugin=b,this.options=a.extend(!0,{},b.options.ajaxOptions),this.callbacks={},c=0;g>c;c++){var h=f[c];this.options[h]&&a.isFunction(this.options[h])&&(this.callbacks[h]=this.options[h]),this.options[h]=e(h)}this.options.data&&a.isFunction(this.options.data)&&(this.options.data=this.options.data.apply(this)||{q:"{{{q}}}"}),this.plugin.replaceValue(this.options.data,"{{{q}}}",this.plugin.query),this.jqXHR=a.ajax(this.options)};b.AjaxBootstrapSelectRequest=b.AjaxBootstrapSelectRequest||e,e.prototype.beforeSend=function(){this.plugin.list.save(),this.plugin.list.destroy(),this.plugin.$loading.remove(),this.plugin.$noResults.remove(),this.plugin.options.templates.loading&&(this.plugin.$loading=a(this.plugin.options.templates.loading).appendTo(this.plugin.selectpicker.$menu),this.plugin.list.refresh())},e.prototype.complete=function(){this.plugin.$loading.remove(),this.plugin.list.refresh()},e.prototype.error=function(){this.plugin.list.restore()},e.prototype.process=function(b){var c,d,e,f,g,h,i,j=[],k=[],l=[];if(this.plugin.log(this.plugin.LOG_INFO,"Processing raw data for:",this.plugin.query,b),this.plugin.options.preserveSelected&&this.plugin.list&&(g=this.plugin.list.last())&&g&&(l=l.concat(g.selected)),a.isPlainObject(b))e=l.concat(a.map(b,function(a){return[a]}));else{if(!a.isArray(b))return this.plugin.log(this.plugin.LOG_ERROR,"The data type passed was not an Array or Object.",b),!1;e=l.concat(b)}if(h=[].concat(e),a.isFunction(this.plugin.options.preprocessData)&&(this.plugin.log(this.plugin.LOG_DEBUG,"Invoking preprocessData callback:",this.plugin.options.processData),h=this.plugin.options.preprocessData(h),!a.isArray(h)||!h.length))return this.plugin.log(this.plugin.LOG_ERROR,"The preprocessData callback did not return an array or was empty.",b,h),!1;for(d=h.length,c=0;d>c;c++)f=h[c],this.plugin.log(this.plugin.LOG_DEBUG,"Processing item:",f),a.isPlainObject(f)&&(f.hasOwnProperty("divider")||f.hasOwnProperty("data")&&a.isPlainObject(f.data)&&f.data.divider?(this.plugin.log(this.plugin.LOG_DEBUG,"Item is a divider, ignoring provided data."),j.push({divider:!0})):f.hasOwnProperty("value")?-1===k.indexOf(f.value)?(k.push(f.value),f=a.extend({title:f.value,"class":"",data:{},disabled:!1,selected:!1},f),j.push(f)):this.plugin.log(this.plugin.LOG_DEBUG,"Duplicate item found, ignoring."):this.plugin.log(this.plugin.LOG_DEBUG,'Data item must have a "value" property, skipping.'));return i=[].concat(j),!a.isFunction(this.plugin.options.processData)||(this.plugin.log(this.plugin.LOG_DEBUG,"Invoking processData callback:",this.plugin.options.processData),i=this.plugin.options.processData(i),a.isArray(i)&&i.length)?(this.plugin.options.cache&&this.plugin.query&&(this.plugin.log(this.plugin.LOG_DEBUG,"Caching processed data."),this.plugin.cachedData[this.plugin.query]=i),this.plugin.log(this.plugin.LOG_INFO,"Processed data:",i),i):(this.plugin.log(this.plugin.LOG_ERROR,"The processedData callback did not return an array or was empty.",b,j,i),!1)},e.prototype.success=function(b){if(!a.isArray(b)&&!a.isObject(b))return this.plugin.log(this.plugin.LOG_ERROR,"Request did not return a JSON Array or Object.",b),void this.plugin.list.destroy();if(!Object.keys(b).length)return this.plugin.list.destroy(),this.plugin.options.templates.noResults&&(this.plugin.$noResults=a(this.plugin.options.templates.noResults).appendTo(this.plugin.selectpicker.$menu)),void this.plugin.log(this.plugin.LOG_INFO,"No results were returned.");var c=this.process(b);if(c&&c.length){var d=this.plugin.list.build(c);if(!d.length)return void this.plugin.log(this.plugin.LOG_WARNING,"Unable to build the options from data.",b,d);this.plugin.$element.html(d)}},a.fn.ajaxSelectPicker=function(c){return this.each(function(){a(this).data("AjaxBootstrapSelect")||a(this).data("AjaxBootstrapSelect",new b.AjaxBootstrapSelect(this,c))})},a.fn.ajaxSelectPicker.locale={},/*!
 * English translation for the "en" language code.
 * Mark Carver <mark.carver@me.com>
 */
a.fn.ajaxSelectPicker.locale["en-US"]={noResults:"No Results",searchPlaceholder:"Search...",searching:"Searching..."},a.fn.ajaxSelectPicker.locale.en=a.fn.ajaxSelectPicker.locale["en-US"]}(jQuery,window);